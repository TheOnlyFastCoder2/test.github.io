<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=650, initial-scale=1.0, maximum-scale=1.0">
    <title>FomoFarm Calculator</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Manrope:wght@200..800&display=swap" rel="stylesheet">
    <style>
        /* General Styles */
        * { box-sizing: border-box; }
        body {
            font-family: 'Manrope', sans-serif; margin: 20px; background-color: #000000;
            color: #ffffff; display: flex; justify-content: center; align-items: flex-start;
            min-height: 100vh; padding-bottom: 50px;
        }
        .container {
            max-width: 650px; width: 100%; margin: auto;
            background: linear-gradient(to top, #000000, #05001d); padding: 20px;
            border: 1px solid #4ade80; border-radius: 8px; box-shadow: 0 2px 10px rgba(7, 14, 10, 0.5);
        }
        .header-container {
            display: flex; justify-content: space-between; align-items: center;
            margin-bottom: 20px; flex-wrap: wrap; gap: 10px;
        }
        h1 {
            font-size: 30px; font-weight: 900; margin: 0; letter-spacing: -1px;
            display: flex; align-items: center; justify-content: center; gap: 10px;
            flex-grow: 1; justify-content: flex-start;
        }
        h1 svg { }
        h1 span#appTitle {
            background-image: linear-gradient(to right, #0ea5e9, #7dd3fc );
            background-clip: text; -webkit-background-clip: text; color: transparent;
        }
        h2 { /* Results Heading */
            margin-block-start: 0em; margin-block-end: 0em; font-size: 30px;
            text-align: left; font-weight: 800; letter-spacing: -0.5px; color: #4ade80;
            margin-top: 0px; margin-bottom: 15px; border-bottom: 1px solid #374151; padding-bottom: 8px;
        }
        h3 { /* Section Heading (e.g., Referrals) */
            font-size: 30px; margin-top: 25px; margin-block-start: 0em; margin-block-end: 0em;
            text-align: center; font-weight: 700; letter-spacing: -0.5px; color: #e5e7eb;
            margin-bottom: 15px; /* Adjusted margin */
        }
        h4 { /* Results Sub-heading */
             font-size: 16px; color: #dfdfdf; font-weight: 600; margin-top: 15px;
             margin-bottom: 8px; border-bottom: 1px dashed #374151; padding-bottom: 4px;
        }
        h4:first-of-type { margin-top: 0;}

        /* Input Group - CSS Grid */
        .input-group {
            display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px;
            margin-bottom: 20px; /* Restore default margin */
        }
        .input-group > div {
            padding: 10px; border: 1px solid #1f2937; border-radius: 8px;
            background-color: #111827; box-shadow: rgba(7, 14, 10, 0.5) 4px 4px 4px 0px inset;
        }

        /* Default label style */
        label {
            display: block; font-size: 14px; font-weight: 500; letter-spacing: inherit;
            color: #cbd5e1; margin-bottom: 5px;
        }
        .input-group > div > label { height: auto; min-height: 0; }

        /* Default input/select style */
        input[type="number"], select {
            width: 100%; padding: 8px 10px; margin-top: 0; border: 1px solid #374151;
            border-radius: 6px; font-size: 14px; font-family: 'Manrope', sans-serif;
            color: #ffffff; background-color: #000000; transition: border-color 0.3s ease;
        }
        input[type="number"]:focus, select:focus { outline: none; border-color: #4ade80; }
        select {
             appearance: none;
             background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 24 24' stroke-width='1.5' stroke='%239ca3af' class='w-6 h-6'%3E%3Cpath stroke-linecap='round' stroke-linejoin='round' d='m19.5 8.25-7.5 7.5-7.5-7.5' /%3E%3C/svg%3E%0A");
             background-repeat: no-repeat; background-position: right 10px center;
             background-size: 16px; padding-right: 30px;
        }
        input[type=number]::-webkit-inner-spin-button,
        input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type=number] { -moz-appearance: textfield; }

        /* --- UPDATED: Checkbox Container Styles --- */
        .checkbox-container {
            display: flex; /* Use flexbox */
            justify-content: center; /* Center items horizontally */
            gap: 40px; /* Adjust gap between checkboxes */
            margin-top: 0; /* Remove top margin as it's after input-group */
            margin-bottom: 25px; /* Space below checkboxes */
            padding: 10px 0; /* Add some vertical padding */
            flex-wrap: wrap;
        }
        .checkbox-item {
            display: flex; align-items: center; gap: 8px;
            /* margin-bottom: 10px; Removed margin for horizontal layout */
            justify-content: center; /* Center content within item */
        }
        .checkbox-item input[type="checkbox"] {
            width: 18px; height: 18px; margin: 0; cursor: pointer; accent-color: #4ade80;
            border: 1px solid #374151; border-radius: 3px; vertical-align: middle;
            flex-shrink: 0;
        }
        .checkbox-item input[type="checkbox"]:focus { outline: 1px solid #4ade80; outline-offset: 1px; }
        .checkbox-item label {
            font-size: 14px; font-weight: 500; color: #cbd5e1; cursor: pointer;
            margin-bottom: 0; line-height: 1; min-height: auto; display: inline;
            align-items: initial; padding-bottom: 0;
        }

        /* General Button Styles */
        button {
            width: auto; padding: 10px 20px; border: none; border-radius: 6px; font-size: 15px;
            text-transform: uppercase; font-family: 'Manrope', sans-serif; background-color: #7c3aed;
            letter-spacing: inherit; color: #fff; cursor: pointer; font-weight: 700;
            transition: background-color 0.3s ease, transform 0.1s ease, opacity 0.3s ease;
        }
        button:hover { background-color: #6d28d9; }
        button:active { transform: scale(0.98); }
        button:disabled { background-color: #585063; cursor: not-allowed; opacity: 0.6; }
        button:disabled:hover { background-color: #585063; }

        #languageToggleButton {
            padding: 6px 12px; font-size: 12px; background-color: #374151; text-transform: none;
            font-weight: 500; margin-top: 0; order: 2;
        }
        #languageToggleButton:hover { background-color: #4b5563; }
        #languageToggleButton:disabled { background-color: #374151; cursor: pointer; opacity: 1; }
        #languageToggleButton:disabled:hover { background-color: #4b5563;}

        /* Referrals Section */
        .referrals { margin-top: 15px; text-align: center; }
        .referrals table {
            width: 100%; border-collapse: collapse; margin-top: 15px; margin-bottom: 15px;
            letter-spacing: inherit; table-layout: fixed;
        }
        .referrals th, .referrals td {
            padding: 8px 10px;
            text-align: center; font-size: 14px; background-color: #111827;
            border: 1px solid #1f2937; letter-spacing: inherit; word-wrap: break-word;
            vertical-align: middle;
        }
         .referrals th { font-weight: 600; color: #9ca3af; }
         .referrals th:nth-child(1) { width: 20%; }
         .referrals th:nth-child(2) { width: 45%; }
         .referrals th:nth-child(3) { width: 35%; }

         .referrals td.stakes-summary {
             font-size: 13px; color: #d1d5db; text-align: left; white-space: pre-wrap;
          }
         .referrals td.actions-cell {
             display: flex; justify-content: center; align-items: center; gap: 8px;
             padding: 8px 5px;
          }
         .referrals td .action-button {
             margin: 0; padding: 6px 8px; font-size: 12px;
             border-radius: 4px; font-weight: 500; text-transform: none;
             min-width: 65px; text-align: center;
          }
         .referrals td .edit-button { background-color: #f59e0b; }
         .referrals td .edit-button:hover { background-color: #d97706; }
         .referrals td .remove-button { background-color: #ef4444; }
         .referrals td .remove-button:hover { background-color: #dc2626; }

         /* --- NEW: Collapsible Referrals Styles --- */
         .collapsible-header {
             cursor: pointer;
             display: flex;
             align-items: center;
             justify-content: center;
             gap: 8px;
             user-select: none; /* Предотвратить выделение текста */
             margin-bottom: 5px; /* Уменьшен отступ снизу */
         }
         .toggle-icon {
             transition: transform 0.3s ease;
             font-size: 0.8em; /* Немного уменьшить иконку */
             color: #9ca3af; /* Цвет иконки */
         }
         .collapsible-content {
             /* Содержимое будет показано по умолчанию */
             /* margin-top: 10px; Добавлен отступ сверху для контента */
             /* Убрал margin-top, т.к. отступ уже есть у h3 */
         }
         .referrals.collapsed .collapsible-content {
             display: none; /* Скрыть контент */
         }
         .referrals.collapsed .toggle-icon {
             transform: rotate(-90deg); /* Повернуть иконку */
         }
         #addReferralButton { /* Убедимся, что кнопка Добавить Реферала имеет верхний отступ */
             background-color: #3b82f6;
             margin-top: 10px; /* Добавлен отступ сверху */
         }
         #addReferralButton:hover { background-color: #2563eb; }
         /* --- End NEW Styles --- */

        /* Results Section */
        .results {
            margin-top: 25px; padding: 20px; background-color: #111827;
            border: 1px solid #1f2937; box-shadow: rgba(7, 14, 10, 0.5) 4px 4px 4px 0px inset;
            border-radius: 8px;
        }
        .result-item {
            display: flex; justify-content: space-between; padding: 6px 0;
            border-bottom: 1px solid #283141; font-size: 14px;
        }
        .result-item:last-child { border-bottom: none; }
        .result-item .label { color: #9ca3af; }
        .result-item .value { color: #ffffff; font-weight: 600; text-align: right; }
        .result-item .value.profit-sol,
        .result-item .value.profit-usdc,
        .result-item .value.profit-percent { color: #4ade80; }
        .result-item .value.roi,
        .result-item .value.doubling { color: #fbbf24; }
        .result-item .value.balance-usd { color: #60a5fa; }

        /* --- UPDATED: Calculate Button Styles --- */
        #calculateButton {
            background-color: #22c55e;
            margin-top: 25px; /* Add margin above the button */
            margin-right: 0; /* Reset right margin */
            display: block; /* Make it block level */
            width: auto; /* Make it full width */
            max-width: 200px; /* Optional: Limit max width */
            margin-left: auto; /* Center align (with max-width) */
            margin-right: auto; /* Center align (with max-width) */
        }
        #calculateButton:hover { background-color: #16a34a; }

        /* Footer */
        .textContent { text-align: center; margin-top: 20px; font-size: 15px; color: #6b7280; }
        .textContent p { display: block; margin-block-start: 0em; margin-block-end: 0em; margin-inline-start: 0px; margin-inline-end: 0px; unicode-bidi: isolate; }
        .textContent i { color: #6b7280; margin: 0 2px; }
        .textContent a { color: #3b82f6; text-decoration: none; }
        .textContent a:hover { text-decoration: underline; }

        /* --- Modal Styles --- */
        .modal-overlay { display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
        .modal-content { background: linear-gradient(to bottom, #111827, #05001d); margin: auto; padding: 25px; border: 1px solid #4ade80; border-radius: 8px; width: 90%; max-width: 550px; box-shadow: 0 5px 15px rgba(0,0,0,0.3); position: relative; }
        .modal-header { padding-bottom: 15px; border-bottom: 1px solid #374151; margin-bottom: 20px; }
        .modal-header h4 { margin: 0; font-size: 20px; font-weight: 700; color: #e5e7eb; }
        .modal-body { max-height: 60vh; overflow-y: auto; padding-right: 10px; }
        .modal-body .input-pair { margin-bottom: 15px; }
        .modal-body .input-pair label { margin-bottom: 5px; font-size: 13px; color: #9ca3af; }
        .modal-body .input-pair input { width: 100%; font-size: 14px; padding: 6px 8px; }
        .modal-footer { padding-top: 20px; border-top: 1px solid #374151; margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
        .modal-footer button { padding: 8px 18px; font-size: 14px; }
        #saveReferralButton { background-color: #22c55e; }
        #saveReferralButton:hover { background-color: #16a34a; }
        #cancelReferralButton { background-color: #6b7280; }
        #cancelReferralButton:hover { background-color: #4b5563; }

    </style>
</head>
<body>
    <div class="container">
        <div class="header-container">
             <h1>
                 <svg width="60" height="60" viewBox="0 0 119.01 73.79" preserveAspectRatio="xMidYMid meet">
                     <defs> <linearGradient id="linear-gradient" x1="15" y1="75.16" x2="117" y2="14.9" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".16" stop-color="#3794e5"/> <stop offset=".36" stop-color="#4cbaef"/> <stop offset=".46" stop-color="#55c9f3"/> <stop offset=".65" stop-color="#60def9"/> <stop offset=".84" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient1" x1="23.33" y1="67.19" x2="115.05" y2="17.36" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".15" stop-color="#2a7ada"/> <stop offset=".34" stop-color="#338bdf"/> <stop offset=".56" stop-color="#42a6e8"/> <stop offset=".8" stop-color="#56ccf3"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient2" x1="5.49" y1="59.23" x2="107.52" y2=".56" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".17" stop-color="#2979da"/> <stop offset=".35" stop-color="#3085de"/> <stop offset=".54" stop-color="#3b9be4"/> <stop offset=".73" stop-color="#4bb8ed"/> <stop offset=".91" stop-color="#60def8"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient3" x1="22.29" y1="69.52" x2="115.96" y2="15.28" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2b7cdb"/> <stop offset=".36" stop-color="#3691e1"/> <stop offset=".62" stop-color="#48b3eb"/> <stop offset=".91" stop-color="#62e2fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient4" x1="5.15" y1="58.96" x2="97.33" y2="7.21" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".26" stop-color="#2877d9"/> <stop offset=".43" stop-color="#2d80dc"/> <stop offset=".58" stop-color="#358fe1"/> <stop offset=".71" stop-color="#41a4e7"/> <stop offset=".84" stop-color="#50c0ef"/> <stop offset=".95" stop-color="#62e1fa"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient5" x1="24.22" y1="66.48" x2="116.12" y2="15.04" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2775d9"/> <stop offset=".14" stop-color="#2a7bdb"/> <stop offset=".35" stop-color="#358fe0"/> <stop offset=".6" stop-color="#46aeea"/> <stop offset=".87" stop-color="#5edaf7"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> <linearGradient id="linear-gradient6" x1="1.45" y1="41.31" x2="91.67" y2="-11.99" gradientUnits="userSpaceOnUse"> <stop offset="0" stop-color="#2573dc"/> <stop offset=".24" stop-color="#43a9ea"/> <stop offset=".4" stop-color="#55c9f3"/> <stop offset=".61" stop-color="#60def9"/> <stop offset=".82" stop-color="#68edfd"/> <stop offset="1" stop-color="#6bf2ff"/> </linearGradient> </defs> <polygon points="78.92 14.22 66.17 14.22 19.83 41.17 9.25 67.33 29.87 67.33 33.62 58.9 48.26 50.55 40.94 67.33 55.45 67.33 68.14 39.22 82.43 31.07 66.61 67.33 80.94 67.33 101.06 20.45 105.5 17.92 107 23.75 114.08 8.92 97.75 8 102.07 12.39 18.67 60.34 22.07 52.31 25.22 45.11 78.92 14.22" fill="url(#linear-gradient)"/> <polygon points="44.42 59.36 63.85 48.71 68.14 39.22 48.26 50.55 44.42 59.36" fill="url(#linear-gradient1)"/> <polygon points="59.04 25.55 55.7 33.14 75.53 21.83 78.92 14.22 59.04 25.55" fill="url(#linear-gradient2)"/> <polygon points="82.43 31.07 78.2 40.76 97.32 29.17 101.06 20.45 82.43 31.07" fill="url(#linear-gradient3)"/> <polygon points="25.22 45.11 22.07 52.31 41.69 41.13 44.97 33.75 25.22 45.11" fill="url(#linear-gradient4)"/> <polygon points="29.87 67.33 33.62 58.9 15.53 67.33 29.87 67.33" fill="url(#linear-gradient5)"/> <polygon points="38.44 14.22 32.5 27.83 52.55 16.36 53.5 14.22 38.44 14.22" fill="url(#linear-gradient6)"/>
                 </svg>
                 <span id="appTitle">FomoFarm Calculator</span>
             </h1>
             <button id="languageToggleButton"></button>
        </div>

        <div class="input-group">
            <div>
                <label for="userStakedSolAmount" id="label-user-staked-sol">Staked (SOL):</label>
                <input type="number" id="userStakedSolAmount" value="0" step="0.001" min="0">
            </div>
            <div>
                <label for="userProfitPercentSol" id="label-user-profit-percent-sol">Profit % / day (SOL):</label>
                <input type="number" id="userProfitPercentSol" value="0" step="0.01" min="0">
            </div>
             <div>
                <label for="days" id="label-days">Days:</label>
                <input type="number" id="days" value="0" step="1" min="0">
            </div>
            <div>
                <label for="userStakedUsdcAmount" id="label-user-staked-usdc">Staked (USDC):</label>
                <input type="number" id="userStakedUsdcAmount" value="0" step="0.01" min="0">
            </div>
             <div>
                <label for="userProfitPercentUsdc" id="label-user-profit-percent-usdc">Profit % / day (USDC):</label>
                <input type="number" id="userProfitPercentUsdc" value="0" step="0.01" min="0">
            </div>
             <div id="platformFeeContainer"> <label for="platformFee" id="label-platform-fee">FomoFarm Fee (%):</label>
                <input type="number" id="platformFee" value="10" step="0.1" min="0">
            </div>
            <div>
                <label for="solToUsd" id="label-sol-usd">SOL / USD:</label>
                <input type="number" id="solToUsd" value="0" step="0.01" min="0">
            </div>
             </div>

        <div class="checkbox-container">
             <div class="checkbox-item">
                 <input type="checkbox" id="reinvestCheckbox">
                 <label for="reinvestCheckbox" id="label-reinvest">Reinvestment</label>
             </div>
             <div class="checkbox-item">
                 <input type="checkbox" id="includeReferralsCheckbox">
                 <label for="includeReferralsCheckbox" id="label-enable-referrals">Enable Referrals</label>
             </div>
        </div>

        <div class="referrals" id="referralsContainer">
             <h3 id="h3-referrals" class="collapsible-header">
                 <span id="h3-referrals-text">Referrals</span> <i class="fas fa-chevron-down toggle-icon"></i> </h3>
             <div class="collapsible-content"> <button id="addReferralButton">Add Referral</button>
                 <table id="referralsTable">
                     <thead>
                         <tr>
                             <th id="th-referral-num">Referral #</th>
                             <th id="th-ref-stakes">Stakes Summary</th> <th id="th-actions">Actions</th>
                         </tr>
                     </thead>
                     <tbody id="referralsList"></tbody>
                 </table>
            </div>
        </div>
        <button id="calculateButton">Calculate</button>

        <div class="results">
            <h2 id="h2-results">Results</h2>

            <h4 id="h4-your-profit">Your profit</h4>
            <div class="result-item">
                <span class="label" id="label-profit-user-sol">From SOL Stake:</span>
                <span class="value profit-sol" id="result-profit-user-sol">0 SOL</span>
            </div>
            <div class="result-item">
                <span class="label" id="label-profit-user-usdc">From USDC Stake:</span>
                <span class="value profit-usdc" id="result-profit-user-usdc">0 USDC</span>
            </div>

            <h4 id="h4-referral-profit">Profit from referrals</h4>
             <div class="result-item">
                <span class="label" id="label-profit-ref-sol">From SOL Stakes:</span>
                <span class="value profit-sol" id="result-profit-ref-sol">0 SOL</span>
            </div>
            <div class="result-item">
                <span class="label" id="label-profit-ref-usdc">From USDC Stakes:</span>
                <span class="value profit-usdc" id="result-profit-ref-usdc">0 USDC</span>
            </div>

             <h4 id="h4-total-profit">Total profit</h4>
             <div class="result-item">
                <span class="label" id="label-profit-total-sol">Total SOL:</span>
                <span class="value profit-sol" id="result-profit-total-sol">0 SOL</span>
            </div>
            <div class="result-item">
                <span class="label" id="label-profit-total-usdc">Total USDC:</span>
                <span class="value profit-usdc" id="result-profit-total-usdc">0 USDC</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-profit-percent-sol">Profit SOL (% of initial SOL):</span>
                <span class="value profit-percent" id="result-profit-percent-sol">0 %</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-profit-percent-usdc">Profit USDC (% of initial USDC):</span>
                <span class="value profit-percent" id="result-profit-percent-usdc">0 %</span>
            </div>

             <h4 id="h4-doubling-time">Doubling Time (100% Profit)</h4>
             <div class="result-item">
                <span class="label" id="label-double-sol-noreinvest">SOL Stake (No Reinvest):</span>
                <span class="value doubling" id="result-double-sol-noreinvest">N/A</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-double-usdc-noreinvest">USDC Stake (No Reinvest):</span>
                <span class="value doubling" id="result-double-usdc-noreinvest">N/A</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-double-sol-reinvest">SOL Stake (With Reinvest):</span>
                <span class="value doubling" id="result-double-sol-reinvest">N/A</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-double-usdc-reinvest">USDC Stake (With Reinvest):</span>
                <span class="value doubling" id="result-double-usdc-reinvest">N/A</span>
            </div>

             <h4 id="h4-final-balance">Final Balance</h4>
             <div class="result-item">
                <span class="label" id="label-final-balance-sol">Balance SOL:</span>
                <span class="value" id="result-final-balance-sol">0 SOL</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-final-balance-usdc">Balance USDC:</span>
                <span class="value" id="result-final-balance-usdc">0 USDC</span>
            </div>
             <div class="result-item">
                <span class="label" id="label-final-balance-usd">Total Balance (USD):</span>
                <span class="value balance-usd" id="result-final-balance-usd-total">0 $</span>
            </div>

        </div>
        <div class="textContent">
             <p id="p-footer">Made by <i class="fab fa-telegram-plane"></i> AslChernov</p>
        </div>
    </div>

    <div id="editReferralModal" class="modal-overlay"> <div class="modal-content">
         <div class="modal-header">
             <h4 id="modalTitle">Edit Referral Data</h4> </div>
         <div class="modal-body">
             <input type="hidden" id="editingReferralId">
             <div class="input-pair">
                  <label for="modal-stake-sol" id="label-modal-stake-sol">Staked (SOL):</label>
                  <input type="number" id="modal-stake-sol" step="0.001" min="0">
             </div>
              <div class="input-pair">
                  <label for="modal-profit-sol" id="label-modal-profit-sol">Profit % / day (SOL):</label>
                  <input type="number" id="modal-profit-sol" step="0.01" min="0">
             </div>
              <div class="input-pair">
                  <label for="modal-stake-usdc" id="label-modal-stake-usdc">Staked (USDC):</label>
                  <input type="number" id="modal-stake-usdc" step="0.01" min="0">
             </div>
              <div class="input-pair">
                  <label for="modal-profit-usdc" id="label-modal-profit-usdc">Profit % / day (USDC):</label>
                  <input type="number" id="modal-profit-usdc" step="0.01" min="0">
             </div>
         </div>
         <div class="modal-footer">
             <button id="cancelReferralButton">Cancel</button> <button id="saveReferralButton">Save</button> </div>
         </div>
    </div>


    <script>
        // Updated Referral Data Structure
        let referralsData = []; // Now stores { id, stakedSol, profitPercentSol, stakedUsdc, profitPercentUsdc }
        const REINVEST_THRESHOLD_SOL = 0.1;
        const REINVEST_THRESHOLD_USDC = 20;

        // --- Translations --- (Updated button text keys)
        const translations = {
            'en': {
                // General UI
                labelUserStakedSol: 'Staked (SOL):', labelUserProfitPercentSol: 'Profit % / day (SOL):',
                labelUserStakedUsdc: 'Staked (USDC):', labelUserProfitPercentUsdc: 'Profit % / day (USDC):',
                labelPlatformFee: 'FomoFarm Fee (%):', labelSolUsd: 'SOL / USD:',
                labelDays: 'Days:', labelReinvest: 'Reinvestment', labelEnableReferrals: 'Enable Referrals',
                calculate: 'Calculate', pFooter: 'Made by', langButtonText: 'Language EN',
                // Referrals Section
                h3Referrals: 'Referrals', addReferral: 'Add Referral', thReferralNum: 'Referral #',
                thRefStakes: 'Stakes Summary', thActions: 'Actions',
                editButtonShort: 'Edit', removeButtonShort: 'Remove',
                noReferrals: 'No referrals added yet.', refSummaryNone: '-',
                // Modal
                modalTitlePrefix: 'Edit Data for Referral #',
                labelModalStakeSol: 'Staked (SOL):', labelModalProfitSol: 'Profit % / day (SOL):',
                labelModalStakeUsdc: 'Staked (USDC):', labelModalProfitUsdc: 'Profit % / day (USDC):',
                saveButton: 'Save', cancelButton: 'Cancel',
                // Results Section
                h2Results: 'Results',
                h4YourProfit: 'Your profit', labelProfitUserSol: 'From SOL Stake:', labelProfitUserUsdc: 'From USDC Stake:',
                h4ReferralProfit: 'Profit from referrals', labelProfitRefSol: 'From SOL Stakes:', labelProfitRefUsdc: 'From USDC Stakes:',
                h4TotalProfit: 'Total profit', labelProfitTotalSol: 'Total SOL:', labelProfitTotalUsdc: 'Total USDC:',
                labelProfitPercentSol: 'Profit SOL (% of initial SOL):', labelProfitPercentUsdc: 'Profit USDC (% of initial USDC):',
                h4DoublingTime: 'Doubling Time (100% Profit)',
                labelDoubleSolNoreinvest: 'SOL Stake (No Reinvest):', labelDoubleUsdcNoreinvest: 'USDC Stake (No Reinvest):',
                labelDoubleSolReinvest: 'SOL Stake (With Reinvest):', labelDoubleUsdcReinvest: 'USDC Stake (With Reinvest):',
                h4FinalBalance: 'Final Balance',
                labelFinalBalanceSol: 'Balance SOL:', labelFinalBalanceUsdc: 'Balance USDC:', labelFinalBalanceUsd: 'Total Balance (USD):',
                // Other
                roiNever: 'Never', roiOverDays: 'Over {days} days', daysSuffix: ' days',
                invalidInputError: 'Please enter valid values for Stakes, Rates, Days, and SOL/USD Rate.',
                solUsdRateError: 'SOL/USD rate must be greater than 0 to calculate profit from USDC stakes.'
            },
            'ru': {
                 // General UI
                labelUserStakedSol: 'Вложено (SOL):', labelUserProfitPercentSol: 'Профит % / день (SOL):',
                labelUserStakedUsdc: 'Вложено (USDC):', labelUserProfitPercentUsdc: 'Профит % / день (USDC):',
                labelPlatformFee: 'Комиссия FomoFarm (%):', labelSolUsd: 'SOL / USD:',
                labelDays: 'Дней:', labelReinvest: 'Реинвест', labelEnableReferrals: 'Включить рефералов',
                calculate: 'Рассчитать', pFooter: 'Сделано', langButtonText: 'Язык RU',
                 // Referrals Section
                h3Referrals: 'Рефералы', addReferral: 'Добавить реферала', thReferralNum: 'Реферал №',
                thRefStakes: 'Сводка стейков', thActions: 'Действия',
                editButtonShort: 'Изм.', removeButtonShort: 'Удал.',
                noReferrals: 'Рефералы еще не добавлены.', refSummaryNone: '-',
                // Modal
                modalTitlePrefix: 'Изменить данные для Реферала №',
                labelModalStakeSol: 'Вложено (SOL):', labelModalProfitSol: 'Профит % / день (SOL):',
                labelModalStakeUsdc: 'Вложено (USDC):', labelModalProfitUsdc: 'Профит % / день (USDC):',
                saveButton: 'Сохранить', cancelButton: 'Отмена',
                // Results Section
                h2Results: 'Результаты',
                h4YourProfit: 'Ваш профит', labelProfitUserSol: 'От стейка SOL:', labelProfitUserUsdc: 'От стейка USDC:',
                h4ReferralProfit: 'Профит от рефералов', labelProfitRefSol: 'От стейков SOL:', labelProfitRefUsdc: 'От стейков USDC:',
                h4TotalProfit: 'Общий профит', labelProfitTotalSol: 'Всего SOL:', labelProfitTotalUsdc: 'Всего USDC:',
                labelProfitPercentSol: 'Профит SOL (% от нач. SOL):', labelProfitPercentUsdc: 'Профит USDC (% от нач. USDC):',
                h4DoublingTime: 'Время удвоения (100% Профит)',
                labelDoubleSolNoreinvest: 'Стейк SOL (Без реинвеста):', labelDoubleUsdcNoreinvest: 'Стейк USDC (Без реинвеста):',
                labelDoubleSolReinvest: 'Стейк SOL (С реинвестом):', labelDoubleUsdcReinvest: 'Стейк USDC (С реинвестом):',
                h4FinalBalance: 'Итоговый баланс',
                labelFinalBalanceSol: 'Баланс SOL:', labelFinalBalanceUsdc: 'Баланс USDC:', labelFinalBalanceUsd: 'Общий Баланс (USD):',
                // Other
                roiNever: 'Никогда', roiOverDays: 'Более {days} дн.', daysSuffix: ' дн.',
                invalidInputError: 'Пожалуйста, введите корректные значения для Стейков, Процентов, Дней и Курса SOL/USD.',
                solUsdRateError: 'Курс SOL/USD должен быть больше 0 для расчета дохода со стейков в USDC.'
            }
        };

        let currentLanguage = 'en';
        let nextReferralId = 1;

        // --- Language Switching ---
        function updateUI(lang) {
            currentLanguage = lang;
            const trans = translations[lang];
            document.documentElement.lang = lang === 'ru' ? 'ru' : 'en';

            // === NEW: Update referral header text directly ===
            const h3ReferralsTextElement = document.getElementById('h3-referrals-text');
            if (h3ReferralsTextElement && trans.h3Referrals) {
                h3ReferralsTextElement.textContent = trans.h3Referrals;
            }
            // === END NEW ===

            // Update static elements using idToKeyMap (excluding h3-referrals)
            const idToKeyMap = {
                'label-user-staked-sol': 'labelUserStakedSol', 'label-user-profit-percent-sol': 'labelUserProfitPercentSol',
                'label-user-staked-usdc': 'labelUserStakedUsdc', 'label-user-profit-percent-usdc': 'labelUserProfitPercentUsdc',
                'label-platform-fee': 'labelPlatformFee', 'label-sol-usd': 'labelSolUsd', 'label-days': 'labelDays',
                'label-reinvest': 'labelReinvest', 'label-enable-referrals': 'labelEnableReferrals',
                /* 'h3-referrals': 'h3Referrals', --- Removed, handled above --- */
                'addReferralButton': 'addReferral', 'th-referral-num': 'thReferralNum',
                'th-ref-stakes': 'thRefStakes', 'th-actions': 'thActions', 'calculateButton': 'calculate', 'h2-results': 'h2Results',
                'h4-your-profit': 'h4YourProfit', 'label-profit-user-sol': 'labelProfitUserSol', 'label-profit-user-usdc': 'labelProfitUserUsdc',
                'h4-referral-profit': 'h4ReferralProfit', 'label-profit-ref-sol': 'labelProfitRefSol', 'label-profit-ref-usdc': 'labelProfitRefUsdc',
                'h4-total-profit': 'h4TotalProfit', 'label-profit-total-sol': 'labelProfitTotalSol', 'label-profit-total-usdc': 'labelProfitTotalUsdc',
                'label-profit-percent-sol': 'labelProfitPercentSol', 'label-profit-percent-usdc': 'labelProfitPercentUsdc',
                'h4-doubling-time': 'h4DoublingTime',
                'label-double-sol-noreinvest': 'labelDoubleSolNoreinvest', 'label-double-usdc-noreinvest': 'labelDoubleUsdcNoreinvest',
                'label-double-sol-reinvest': 'labelDoubleSolReinvest', 'label-double-usdc-reinvest': 'labelDoubleUsdcReinvest',
                'h4-final-balance': 'h4FinalBalance', 'label-final-balance-sol': 'labelFinalBalanceSol',
                'label-final-balance-usdc': 'labelFinalBalanceUsdc', 'label-final-balance-usd': 'labelFinalBalanceUsd',
                'label-modal-stake-sol': 'labelModalStakeSol', 'label-modal-profit-sol': 'labelModalProfitSol',
                'label-modal-stake-usdc': 'labelModalStakeUsdc', 'label-modal-profit-usdc': 'labelModalProfitUsdc',
                'saveReferralButton': 'saveButton', 'cancelReferralButton': 'cancelButton',
                'languageToggleButton': 'langButtonText'
            };

            for (const id in idToKeyMap) {
                const element = document.getElementById(id);
                const key = idToKeyMap[id];
                if (element && trans[key]) {
                     if (element.tagName === 'BUTTON' || element.tagName === 'H2' || /* element.tagName === 'H3' || */ element.tagName === 'H4' || element.tagName === 'LABEL' || element.tagName === 'P' || element.tagName === 'SPAN' || element.tagName === 'TH') {
                         if (id === 'p-footer') { element.childNodes[0].nodeValue = trans[key] + ' '; }
                         else { element.textContent = trans[key]; }
                     }
                } else if (element && id === 'p-footer') {
                     if (element.childNodes.length === 0 || element.childNodes[0].nodeType !== Node.TEXT_NODE) { element.prepend(document.createTextNode(' ')); }
                     element.childNodes[0].nodeValue = (trans.pFooter || 'Made by') + ' ';
                }
            }
            renderReferralsTable(); // Update button text & summary in table
        }


        function toggleLanguage() {
            const newLang = currentLanguage === 'en' ? 'ru' : 'en';
            localStorage.setItem('fomoFarmCalc_language', newLang);
            updateUI(newLang);
        }

        // --- Data Persistence ---
        function saveData() {
            try {
                const data = {
                    userStakedSolAmount: document.getElementById('userStakedSolAmount').value,
                    userProfitPercentSol: document.getElementById('userProfitPercentSol').value,
                    userStakedUsdcAmount: document.getElementById('userStakedUsdcAmount').value,
                    userProfitPercentUsdc: document.getElementById('userProfitPercentUsdc').value,
                    platformFee: document.getElementById('platformFee').value,
                    solToUsd: document.getElementById('solToUsd').value,
                    days: document.getElementById('days').value,
                    reinvest: document.getElementById('reinvestCheckbox').checked.toString(),
                    includeReferrals: document.getElementById('includeReferralsCheckbox').checked.toString(),
                    referralsData: JSON.stringify(referralsData || []),
                    nextReferralId: nextReferralId,
                    // === NEW: Save collapse state ===
                    referralsCollapsed: document.getElementById('referralsContainer')?.classList.contains('collapsed').toString() || 'false'
                };
                localStorage.removeItem('fomoFarmCalc_solToRub');
                for (const [key, value] of Object.entries(data)) {
                     localStorage.setItem(`fomoFarmCalc_${key}`, value);
                }
            } catch (error) { console.error("Error saving data to localStorage:", error); }
        }

        function loadData() {
            try {
                document.getElementById('userStakedSolAmount').value = localStorage.getItem('fomoFarmCalc_userStakedSolAmount') || '0';
                document.getElementById('userProfitPercentSol').value = localStorage.getItem('fomoFarmCalc_userProfitPercentSol') || '0';
                document.getElementById('userStakedUsdcAmount').value = localStorage.getItem('fomoFarmCalc_userStakedUsdcAmount') || '0';
                document.getElementById('userProfitPercentUsdc').value = localStorage.getItem('fomoFarmCalc_userProfitPercentUsdc') || '0';
                document.getElementById('platformFee').value = localStorage.getItem('fomoFarmCalc_platformFee') || '10';
                document.getElementById('solToUsd').value = localStorage.getItem('fomoFarmCalc_solToUsd') || '0';
                document.getElementById('days').value = localStorage.getItem('fomoFarmCalc_days') || '0';
                document.getElementById('reinvestCheckbox').checked = (localStorage.getItem('fomoFarmCalc_reinvest') || 'true') === 'true';
                document.getElementById('includeReferralsCheckbox').checked = (localStorage.getItem('fomoFarmCalc_includeReferrals') || 'true') === 'true';
                const savedReferrals = localStorage.getItem('fomoFarmCalc_referralsData');
                referralsData = savedReferrals ? JSON.parse(savedReferrals) : [];
                if (!Array.isArray(referralsData)) { referralsData = []; }
                referralsData = referralsData.filter(ref => typeof ref === 'object' && ref !== null && ref.hasOwnProperty('id'));
                referralsData.forEach(ref => {
                     ref.stakedSol = ref.stakedSol || 0; ref.profitPercentSol = ref.profitPercentSol || 0;
                     ref.stakedUsdc = ref.stakedUsdc || 0; ref.profitPercentUsdc = ref.profitPercentUsdc || 0;
                });
                if (referralsData.length > 0) { const maxId = referralsData.reduce((max, ref) => Math.max(max, ref.id), 0); nextReferralId = maxId + 1; }
                else { nextReferralId = 1; }
                 const savedNextId = parseInt(localStorage.getItem('fomoFarmCalc_nextReferralId'));
                 if (!isNaN(savedNextId) && savedNextId > nextReferralId) { /* nextReferralId = savedNextId; */ }
                currentLanguage = localStorage.getItem('fomoFarmCalc_language') || 'en';
                 // Note: Collapse state is loaded separately in applyInitialReferralsCollapseState
            } catch (error) {
                console.error("Error loading data from localStorage:", error);
                 document.getElementById('userStakedSolAmount').value = '0'; document.getElementById('userProfitPercentSol').value = '0';
                 document.getElementById('userStakedUsdcAmount').value = '0'; document.getElementById('userProfitPercentUsdc').value = '0';
                referralsData = []; nextReferralId = 1; document.getElementById('reinvestCheckbox').checked = true;
                document.getElementById('includeReferralsCheckbox').checked = true; currentLanguage = 'en';
            }
        }

        // --- Event Listeners Setup ---
        function setupEventListeners() {
             document.querySelectorAll('.input-group input, .checkbox-container input').forEach(element => { element.addEventListener('change', saveData); });
             document.getElementById('languageToggleButton').addEventListener('click', toggleLanguage);
             document.getElementById('addReferralButton').addEventListener('click', addReferral);
             document.getElementById('saveReferralButton').addEventListener('click', saveReferralData);
             document.getElementById('cancelReferralButton').addEventListener('click', closeEditModal);
             document.getElementById('editReferralModal').addEventListener('click', (event) => { if (event.target === event.currentTarget) { closeEditModal(); } });
             document.getElementById('calculateButton').addEventListener('click', calculate);
             // === NEW: Add listener for referral header click ===
             document.getElementById('h3-referrals').addEventListener('click', toggleReferralsSection);
        }

        // --- Referral Management ---
        function addReferral() { const newId = nextReferralId++; const newReferral = { id: newId, stakedSol: 0, profitPercentSol: 0, stakedUsdc: 0, profitPercentUsdc: 0 }; referralsData.push(newReferral); renderReferralsTable(); saveData(); }
        function removeReferral(referralIdToRemove) { referralsData = referralsData.filter(ref => ref.id !== referralIdToRemove); referralsData.forEach((ref, index) => { ref.id = index + 1; }); nextReferralId = referralsData.length + 1; renderReferralsTable(); saveData(); }

        function renderReferralsTable() {
            const referralsListBody = document.getElementById('referralsList');
            if (!referralsListBody) return;
            referralsListBody.innerHTML = '';
            const trans = translations[currentLanguage];

            if (referralsData.length === 0) {
                 const row = document.createElement('tr');
                 row.innerHTML = `<td colspan="3" style="text-align:center; color:#6b7280;">${trans.noReferrals}</td>`;
                 referralsListBody.appendChild(row);
            } else {
                referralsData.forEach(referral => {
                     const row = document.createElement('tr');
                     const numCell = document.createElement('td');
                     numCell.textContent = referral.id;

                     const summaryCell = document.createElement('td');
                     summaryCell.className = 'stakes-summary';
                     let summaryParts = [];
                     const formatOptionsNoSuffix = { maximumFractionDigits: 5, minimumFractionDigits: 2 };
                     const usdcFormatOptionsNoSuffix = { maximumFractionDigits: 2, minimumFractionDigits: 2 };
                     if (referral.stakedSol > 0) { summaryParts.push(`SOL: ${referral.stakedSol.toLocaleString(currentLanguage === 'ru' ? 'ru-RU' : 'en-US', formatOptionsNoSuffix)}`); }
                     if (referral.stakedUsdc > 0) { summaryParts.push(`USDC: ${referral.stakedUsdc.toLocaleString('en-US', usdcFormatOptionsNoSuffix)}`); }
                     summaryCell.textContent = summaryParts.length > 0 ? summaryParts.join(' | ') : trans.refSummaryNone;

                     const actionCell = document.createElement('td');
                     actionCell.className = 'actions-cell';
                     const editButton = document.createElement('button');
                     editButton.textContent = trans.editButtonShort; // Use short text
                     editButton.className = 'action-button edit-button';
                     editButton.onclick = () => openEditModal(referral.id);
                     const removeButton = document.createElement('button');
                     removeButton.textContent = trans.removeButtonShort; // Use short text
                     removeButton.className = 'action-button remove-button';
                     removeButton.onclick = () => removeReferral(referral.id);
                     actionCell.appendChild(editButton);
                     actionCell.appendChild(removeButton);

                     row.appendChild(numCell);
                     row.appendChild(summaryCell);
                     row.appendChild(actionCell);
                     referralsListBody.appendChild(row);
                });
            }
        }


        // --- Modal Management ---
        function openEditModal(referralId) { const modal = document.getElementById('editReferralModal'); const modalTitle = document.getElementById('modalTitle'); const editingIdInput = document.getElementById('editingReferralId'); const trans = translations[currentLanguage]; const referral = referralsData.find(ref => ref.id === referralId); if (!referral) return; modalTitle.textContent = `${trans.modalTitlePrefix}${referral.id}`; editingIdInput.value = referral.id; document.getElementById('modal-stake-sol').value = referral.stakedSol || 0; document.getElementById('modal-profit-sol').value = referral.profitPercentSol || 0; document.getElementById('modal-stake-usdc').value = referral.stakedUsdc || 0; document.getElementById('modal-profit-usdc').value = referral.profitPercentUsdc || 0; document.getElementById('label-modal-stake-sol').textContent = trans.labelModalStakeSol; document.getElementById('label-modal-profit-sol').textContent = trans.labelModalProfitSol; document.getElementById('label-modal-stake-usdc').textContent = trans.labelModalStakeUsdc; document.getElementById('label-modal-profit-usdc').textContent = trans.labelModalProfitUsdc; modal.style.display = 'flex'; }
        function closeEditModal() { const modal = document.getElementById('editReferralModal'); modal.style.display = 'none'; document.getElementById('editingReferralId').value = ''; }
        function saveReferralData() { const editingId = parseInt(document.getElementById('editingReferralId').value); if (isNaN(editingId)) return; const referralIndex = referralsData.findIndex(ref => ref.id === editingId); if (referralIndex === -1) return; const newStakeSol = parseFloat(document.getElementById('modal-stake-sol').value) || 0; const newProfitSol = parseFloat(document.getElementById('modal-profit-sol').value) || 0; const newStakeUsdc = parseFloat(document.getElementById('modal-stake-usdc').value) || 0; const newProfitUsdc = parseFloat(document.getElementById('modal-profit-usdc').value) || 0; referralsData[referralIndex].stakedSol = newStakeSol >= 0 ? newStakeSol : 0; referralsData[referralIndex].profitPercentSol = newProfitSol >= 0 ? newProfitSol : 0; referralsData[referralIndex].stakedUsdc = newStakeUsdc >= 0 ? newStakeUsdc : 0; referralsData[referralIndex].profitPercentUsdc = newProfitUsdc >= 0 ? newProfitUsdc : 0; saveData(); renderReferralsTable(); closeEditModal(); }

        // --- Formatting ---
        function formatNumber(number, currency = 'default') { if (isNaN(number) || number === null) { return currency === 'USD' ? '0.00 $' : (currency === 'RUB' ? '0.00 ₽' : '0.00000'); } const daysSuffix = translations[currentLanguage].daysSuffix; const config = { /*'RUB': { locale: 'ru-RU', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' ₽' },*/ 'USD': { locale: 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' $' }, 'SOL': { locale: 'en-US', options: { maximumFractionDigits: 5, minimumFractionDigits: 2 }, suffix: ' SOL' }, 'USDC': { locale: 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' USDC' }, 'PERCENT': { locale: currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options: { maximumFractionDigits: 2, minimumFractionDigits: 2 }, suffix: ' %' }, 'DAYS': { locale: currentLanguage === 'ru' ? 'ru-RU' : 'en-US', options: { maximumFractionDigits: 0, minimumFractionDigits: 0 }, suffix: daysSuffix }, 'default': { locale: 'en-US', options: { maximumFractionDigits: 5, minimumFractionDigits: 2 }, suffix: '' } }; const { locale, options, suffix } = config[currency] || config.default; return number.toLocaleString(locale, options) + suffix; }

        // --- Calculation Logic ---
        function calculate() {
            const platformFeeRate = (parseFloat(document.getElementById('platformFee').value) || 0) / 100;
            const solToUsd = parseFloat(document.getElementById('solToUsd').value) || 0;
            const days = parseInt(document.getElementById('days').value) || 0;
            const reinvestEnabled = document.getElementById('reinvestCheckbox').checked;
            const referralsEnabled = document.getElementById('includeReferralsCheckbox').checked;
            const trans = translations[currentLanguage];
            const initialUserStakedSol = parseFloat(document.getElementById('userStakedSolAmount').value) || 0;
            const userProfitRateSol = (parseFloat(document.getElementById('userProfitPercentSol').value) || 0) / 100;
            const initialUserStakedUsdc = parseFloat(document.getElementById('userStakedUsdcAmount').value) || 0;
            const userProfitRateUsdc = (parseFloat(document.getElementById('userProfitPercentUsdc').value) || 0) / 100;

            if (days <= 0 || solToUsd < 0 || initialUserStakedSol < 0 || userProfitRateSol < 0 || initialUserStakedUsdc < 0 || userProfitRateUsdc < 0) { clearResults(trans.invalidInputError); return; }
            let needsSolUsdRate = (initialUserStakedUsdc > 0);
             const hasUsdcReferralStake = referralsData.some(ref => (ref.stakedUsdc || 0) > 0);
             if (referralsEnabled && hasUsdcReferralStake) { needsSolUsdRate = true; }
             if (needsSolUsdRate && solToUsd <= 0) { clearResults(trans.solUsdRateError); return; }

            let dailyNetProfit_RefSol = 0; let dailyNetProfit_RefUsdc = 0;
            if (referralsEnabled) {
                referralsData.forEach(referral => {
                     if (referral.stakedSol > 0 && referral.profitPercentSol > 0) { const refProfitRateSol = referral.profitPercentSol / 100; const grossProfit = referral.stakedSol * refProfitRateSol; const fee = grossProfit * platformFeeRate; dailyNetProfit_RefSol += ((grossProfit - fee) * 0.08); }
                     if (referral.stakedUsdc > 0 && referral.profitPercentUsdc > 0) { const refProfitRateUsdc = referral.profitPercentUsdc / 100; const grossProfit = referral.stakedUsdc * refProfitRateUsdc; const fee = grossProfit * platformFeeRate; dailyNetProfit_RefUsdc += ((grossProfit - fee) * 0.08); }
                });
            }

            let doubleSolNoReinvestDays = "N/A"; let doubleUsdcNoReinvestDays = "N/A";
            const dailyNetProfit_UserSol = initialUserStakedSol * userProfitRateSol * (1 - platformFeeRate);
            const dailyNetProfit_UserUsdc = initialUserStakedUsdc * userProfitRateUsdc * (1 - platformFeeRate);
            const totalDailySolProfit = dailyNetProfit_UserSol + dailyNetProfit_RefSol;
            const totalDailyUsdcProfit = dailyNetProfit_UserUsdc + dailyNetProfit_RefUsdc;
            if (totalDailySolProfit > 0 && initialUserStakedSol > 0) { doubleSolNoReinvestDays = Math.ceil(initialUserStakedSol / totalDailySolProfit); } else if (initialUserStakedSol > 0) { doubleSolNoReinvestDays = trans.roiNever; }
            if (totalDailyUsdcProfit > 0 && initialUserStakedUsdc > 0) { doubleUsdcNoReinvestDays = Math.ceil(initialUserStakedUsdc / totalDailyUsdcProfit); } else if (initialUserStakedUsdc > 0) { doubleUsdcNoReinvestDays = trans.roiNever; }

            let currentSolStake = initialUserStakedSol; let currentUsdcStake = initialUserStakedUsdc;
            let accumulatedSolProfit = 0; let accumulatedUsdcProfit = 0;
            let totalSolProfitAccumulated = 0; let totalUsdcProfitAccumulated = 0;
            let doubleSolReinvestDays = "N/A"; let doubleUsdcReinvestDays = "N/A";
            let solDoubled = false; let usdcDoubled = false;

            for (let day = 1; day <= days; day++) {
                const profitTodaySol_User = currentSolStake * userProfitRateSol * (1 - platformFeeRate);
                const profitTodayUsdc_User = currentUsdcStake * userProfitRateUsdc * (1 - platformFeeRate);
                const profitTodaySol_Total = profitTodaySol_User + dailyNetProfit_RefSol;
                const profitTodayUsdc_Total = profitTodayUsdc_User + dailyNetProfit_RefUsdc;
                totalSolProfitAccumulated += profitTodaySol_Total; totalUsdcProfitAccumulated += profitTodayUsdc_Total;
                accumulatedSolProfit += profitTodaySol_Total; accumulatedUsdcProfit += profitTodayUsdc_Total;
                if (reinvestEnabled) {
                     if (accumulatedSolProfit >= REINVEST_THRESHOLD_SOL) { currentSolStake += accumulatedSolProfit; accumulatedSolProfit = 0; }
                     if (accumulatedUsdcProfit >= REINVEST_THRESHOLD_USDC) { currentUsdcStake += accumulatedUsdcProfit; accumulatedUsdcProfit = 0; }
                }
                if (!solDoubled && initialUserStakedSol > 0 && currentSolStake >= initialUserStakedSol * 2) { doubleSolReinvestDays = day; solDoubled = true; }
                if (!usdcDoubled && initialUserStakedUsdc > 0 && currentUsdcStake >= initialUserStakedUsdc * 2) { doubleUsdcReinvestDays = day; usdcDoubled = true; }
            }

             if (!solDoubled) { if (totalDailySolProfit > 0 && initialUserStakedSol > 0) doubleSolReinvestDays = trans.roiOverDays.replace('{days}', days); else if (initialUserStakedSol > 0) doubleSolReinvestDays = trans.roiNever; else doubleSolReinvestDays = "N/A"; }
             if (!usdcDoubled) { if (totalDailyUsdcProfit > 0 && initialUserStakedUsdc > 0) doubleUsdcReinvestDays = trans.roiOverDays.replace('{days}', days); else if (initialUserStakedUsdc > 0) doubleUsdcReinvestDays = trans.roiNever; else doubleUsdcReinvestDays = "N/A"; }

            const finalSolBalance = currentSolStake + accumulatedSolProfit;
            const finalUsdcBalance = currentUsdcStake + accumulatedUsdcProfit;
            const finalUsdBalanceTotal = (solToUsd > 0 ? finalSolBalance * solToUsd : 0) + finalUsdcBalance;
            const profitPercentSol = initialUserStakedSol > 0 ? (totalSolProfitAccumulated / initialUserStakedSol) * 100 : 0;
            const profitPercentUsdc = initialUserStakedUsdc > 0 ? (totalUsdcProfitAccumulated / initialUserStakedUsdc) * 100 : 0;
            const totalReferralProfitOverPeriodSol = dailyNetProfit_RefSol * days;
            const totalReferralProfitOverPeriodUsdc = dailyNetProfit_RefUsdc * days;

            document.getElementById('result-profit-user-sol').textContent = formatNumber(totalSolProfitAccumulated - totalReferralProfitOverPeriodSol, 'SOL');
            document.getElementById('result-profit-user-usdc').textContent = formatNumber(totalUsdcProfitAccumulated - totalReferralProfitOverPeriodUsdc, 'USDC');
             document.getElementById('result-profit-ref-sol').textContent = formatNumber(totalReferralProfitOverPeriodSol, 'SOL');
             document.getElementById('result-profit-ref-usdc').textContent = formatNumber(totalReferralProfitOverPeriodUsdc, 'USDC');
             document.getElementById('result-profit-total-sol').textContent = formatNumber(totalSolProfitAccumulated, 'SOL');
             document.getElementById('result-profit-total-usdc').textContent = formatNumber(totalUsdcProfitAccumulated, 'USDC');
             document.getElementById('result-profit-percent-sol').textContent = formatNumber(profitPercentSol, 'PERCENT');
             document.getElementById('result-profit-percent-usdc').textContent = formatNumber(profitPercentUsdc, 'PERCENT');
             document.getElementById('result-double-sol-noreinvest').textContent = typeof doubleSolNoReinvestDays === 'number' ? formatNumber(doubleSolNoReinvestDays, 'DAYS') : doubleSolNoReinvestDays;
             document.getElementById('result-double-usdc-noreinvest').textContent = typeof doubleUsdcNoReinvestDays === 'number' ? formatNumber(doubleUsdcNoReinvestDays, 'DAYS') : doubleUsdcNoReinvestDays;
             document.getElementById('result-double-sol-reinvest').textContent = typeof doubleSolReinvestDays === 'number' ? formatNumber(doubleSolReinvestDays, 'DAYS') : doubleSolReinvestDays;
             document.getElementById('result-double-usdc-reinvest').textContent = typeof doubleUsdcReinvestDays === 'number' ? formatNumber(doubleUsdcReinvestDays, 'DAYS') : doubleUsdcReinvestDays;
             document.getElementById('result-final-balance-sol').textContent = formatNumber(finalSolBalance, 'SOL');
             document.getElementById('result-final-balance-usdc').textContent = formatNumber(finalUsdcBalance, 'USDC');
             document.getElementById('result-final-balance-usd-total').textContent = formatNumber(finalUsdBalanceTotal, 'USD');
        }

        // Helper function to clear results display
        function clearResults(message = "") {
             document.getElementById('result-profit-user-sol').textContent = '0 SOL'; document.getElementById('result-profit-user-usdc').textContent = '0 USDC';
             document.getElementById('result-profit-ref-sol').textContent = '0 SOL'; document.getElementById('result-profit-ref-usdc').textContent = '0 USDC';
             document.getElementById('result-profit-total-sol').textContent = '0 SOL'; document.getElementById('result-profit-total-usdc').textContent = '0 USDC';
             document.getElementById('result-profit-percent-sol').textContent = '0 %'; document.getElementById('result-profit-percent-usdc').textContent = '0 %';
             document.getElementById('result-double-sol-noreinvest').textContent = 'N/A'; document.getElementById('result-double-usdc-noreinvest').textContent = 'N/A';
             document.getElementById('result-double-sol-reinvest').textContent = 'N/A'; document.getElementById('result-double-usdc-reinvest').textContent = 'N/A';
             document.getElementById('result-final-balance-sol').textContent = '0 SOL'; document.getElementById('result-final-balance-usdc').textContent = '0 USDC';
             document.getElementById('result-final-balance-usd-total').textContent = '0 $';
             if (message) { console.warn(message); }
        }

        // === NEW: Function to toggle referrals section ===
        function toggleReferralsSection() {
            const referralsContainer = document.getElementById('referralsContainer');
            if (referralsContainer) {
                referralsContainer.classList.toggle('collapsed');
                // Save the new state
                saveData(); // saveData now includes the collapse state
            }
        }

        // === NEW: Function to apply initial collapse state ===
        function applyInitialReferralsCollapseState() {
            const referralsContainer = document.getElementById('referralsContainer');
            const savedState = localStorage.getItem('fomoFarmCalc_referralsCollapsed');
            if (referralsContainer && savedState === 'true') {
                referralsContainer.classList.add('collapsed');
            }
            // The CSS handles the icon rotation automatically based on the class
        }


        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
            applyInitialReferralsCollapseState(); // Apply collapse state after loading data
            setupEventListeners(); // Set up listeners, including the new one for collapse
            updateUI(currentLanguage); // Update UI text based on language and state
            clearResults(); // Clear results initially
            renderReferralsTable(); // Ensure table is rendered correctly on load
        });

    </script>
</body>
</html>